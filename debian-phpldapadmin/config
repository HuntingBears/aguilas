#!/bin/bash -e

CONFFILE="/etc/aguilas/config.php"

. /usr/share/debconf/confmodule
db_version 2.0 || [ $? -lt 30 ]

# Autoconfiguration for aguilas
if [ ! -f $CONFFILE ] || [ $( md5sum $CONFFILE | awk '{print $1}' ) = "FIXME" ]; then

	# Let's try to read default from slapd.conf, libnss-ldap.conf or libpam_ldap.conf
	if [ -f /etc/ldap/slapd.conf ]; then

		LDAPSERVER="localhost"

		if grep "^TLS" /etc/ldap/slapd.conf > /dev/null 2>&1; then
			TLS="true"
		else
			TLS="false"
		fi

		BASEDN=$( grep ^suffix /etc/ldap/slapd.conf | awk '{print $2}' | sed -e s/\"//g )
		BINDDN=$( grep -e "by dn=.* write" /etc/ldap/slapd.conf | cut -d"\"" -f2 | head -n1 )

	elif [ -f /etc/libnss-ldap.conf ]; then

		if grep "^host" /etc/libnss-ldap.conf > /dev/null 2>&1; then
			LDAPSERVER=$( grep ^host /etc/libnss-ldap.conf | awk '{print $2}' )
		elif grep "^uri" /etc/libnss-ldap.conf > /dev/null 2>&1; then
			LDAPSERVER=$( grep ^uri /etc/libnss-ldap.conf | sed -e s@/@@g | awk -F : '{print $2}' )
		fi

		if grep "^TLS" /etc/libnss-ldap.conf > /dev/null 2>&1; then
			TLS="true"
		else
			TLS="false"
		fi

		BASEDN=$( grep -e "^base" /etc/libnss-ldap.conf | awk '{print $2}' | sed -e s/\"//g )
		BINDDN=$( grep -e "^rootbinddn" /etc/libnss-ldap.conf | awk '{print $2}' )

	elif [ -f /etc/pam_ldap.conf ]; then

		if grep "^host" /etc/pam_ldap.conf > /dev/null 2>&1; then
			LDAPSERVER=$( grep ^host /etc/pam_ldap.conf | awk '{print $2}' )
		elif grep "^uri" /etc/pam_ldap.conf > /dev/null 2>&1; then
			LDAPSERVER=$( grep ^uri /etc/pam_ldap.conf | sed -e s@/@@g | awk -F : '{print $2}' )
		fi

		if grep "^TLS" /etc/pam_ldap.conf > /dev/null 2>&1; then
			TLS="true"
		else
			TLS="false"
		fi

		BASEDN=$( grep -e "^base" /etc/pam_ldap.conf | awk '{print $2}' | sed -e s/\"//g )
		BINDDN=$( grep -e "^rootbinddn" /etc/pam_ldap.conf | head -n1 | awk '{print $2}' )

	fi

	if [ -f /etc/ldap.secret ]; then
		BINDPW=$( head -n1 /etc/ldap.secret )
	fi

	if [ -z ${LDAPSERVER} ]; then
		db_input medium aguilas/ldap-server || true
		db_go || true
		db_get aguilas/ldap-server || true
		LDAPSERVER="${RET}"
	else
		db_set aguilas/ldap-server ${LDAPSERVER} || true
	fi

	if [ -z ${TLS} ]; then
		db_input medium aguilas/ldap-tls || true
		db_go || true
		db_get aguilas/ldap-tls || true
		TLS="${RET}"
	else
		db_set aguilas/ldap-tls ${TLS} || true
	fi

	if [ "${TLS}" == "true" ]; then
		LDAPSERVER="ldaps:\\/\\/${LDAPSERVER}"
		db_set aguilas/ldap-server ${LDAPSERVER} || true
	fi

	if [ -z ${ENC} ]; then
		db_input medium aguilas/ldap-enc || true
		db_go || true
		db_get aguilas/ldap-enc || true
		ENC="${RET}"
	else
		db_set aguilas/ldap-enc ${ENC} || true
	fi

	if [ -z ${BASEDN} ]; then
		db_input medium aguilas/ldap-basedn || true
		db_go || true
		db_get aguilas/ldap-basedn || true
		BASEDN="${RET}"
	else
		db_set phpldapadmin/ldap-basedn ${BASEDN} || true
	fi
	
	if [ -z ${BINDDN} ]; then
		db_set aguilas/ldap-binddn "cn=admin,${BASEDN}"
		db_input medium aguilas/ldap-binddn || true
		db_go || true
		db_get aguilas/ldap-binddn || true
	else
		db_set aguilas/ldap-binddn ${BINDDN} || true
	fi

	if [ -z ${BINDPW} ]; then
		db_input medium aguilas/ldap-bindpw || true
		db_go || true
	else
		db_set aguilas/ldap-bindpw ${BINDPW} || true
	fi

	db_input medium aguilas/reconfigure-webserver || true
	db_go || true
	db_get aguilas/reconfigure-webserver || true
	WEBSERVERS="${RET}"
	
	if [ -n ${WEBSERVERS} ]; then
		db_input medium aguilas/restart-webserver || true
		db_go || true
	fi

fi

#DEBHELPER#

exit 0
